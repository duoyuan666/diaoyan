<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>营销分析工具（修复版）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', '微软雅黑', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f9f9f9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2rem;
            color: #4a6cf7;
            margin-bottom: 10px;
        }

        .description {
            color: #666;
            max-width: 700px;
            margin: 0 auto 20px;
        }

        /* 全局导出按钮样式 */
        .global-actions {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .export-all-button {
            background-color: #4a6cf7;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(74, 108, 247, 0.2);
            transition: all 0.3s ease;
        }

        .export-all-button:hover {
            background-color: #3a5cd7;
            box-shadow: 0 6px 8px rgba(74, 108, 247, 0.3);
            transform: translateY(-2px);
        }

        .export-all-button svg {
            width: 20px;
            height: 20px;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            padding: 12px 15px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9rem;
            color: #666;
            position: relative;
            transition: color 0.3s;
        }

        .tab.active {
            color: #4a6cf7;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #4a6cf7;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .analysis-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 50px; /* 增加底部空间，避免被右侧预览区挡住 */
        }

        .editor {
            width: 100%;
            height: 500px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: none;
            margin-bottom: 20px;
            font-family: 'Microsoft YaHei', '微软雅黑', sans-serif;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .button {
            background-color: #4a6cf7;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .button:hover {
            opacity: 0.9;
        }

        .button.secondary {
            background-color: #eef2ff;
            color: #4a6cf7;
        }

        .button.secondary:hover {
            background-color: #dce4ff;
        }

        #canvas-container {
            display: none;
        }

        canvas {
            max-width: 100%;
            border: 1px solid #ddd;
        }

        .preview-area {
            margin-top: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .preview-area img {
            max-width: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .page-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .progress-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 16px;
            z-index: 1000;
            display: none;
        }

        /* 右侧多图预览区域样式 */
        .multi-preview-container {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 100;
            max-height: 90vh;
            overflow-y: auto;
        }

        .multi-preview-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #4a6cf7;
            font-size: 16px;
            width: 100%;
            text-align: center;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .multi-preview-container .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        }

        .multi-preview-container .close-btn:hover {
            color: #333;
        }

        .preview-thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            padding: 5px;
        }

        .preview-thumbnail {
            width: 75px;
            height: 100px;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            object-fit: cover;
            transition: all 0.2s;
        }

        .preview-thumbnail:hover {
            transform: scale(1.05);
        }

        .preview-thumbnail.active {
            border-color: #4a6cf7;
        }

        .current-preview {
            width: 100%;
            margin-bottom: 15px;
        }

        .current-preview-title {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 10px;
        }

        .current-preview img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .preview-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 15px;
        }

        .nav-button {
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .nav-button:hover {
            background-color: #e0e0e0;
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .preview-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .preview-indicator {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                display: flex;
                flex-wrap: nowrap;
            }
            .editor {
                height: 350px;
            }
            .button-group {
                flex-direction: column;
            }
            .multi-preview-container {
                position: fixed;
                right: 10px;
                top: auto;
                bottom: 10px;
                transform: none;
                width: 200px;
                max-height: 50vh;
            }
        }

        .logo {
            font-weight: bold;
            color: #4a6cf7;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .logo svg {
            width: 24px;
            height: 24px;
        }
        
        .explanation {
            margin-bottom: 20px; 
            padding: 10px; 
            background-color: #f5f5f5; 
            border-radius: 5px;
            color: #555;
            line-height: 1.5;
        }

        .settings-panel {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .settings-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .settings-group {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .settings-item label {
            font-size: 14px;
            color: #555;
        }

        .settings-item select, 
        .settings-item input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* 添加预设风格样式 */
        .theme-preview {
            width: 24px;
            height: 24px;
            display: inline-block;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            border: 1px solid #ddd;
        }
        
        .theme-option {
            display: flex;
            align-items: center;
            padding: 2px 5px;
        }
        
        /* 自定义列表符号样式 */
        .bullet-preview {
            width: 24px;
            height: 24px;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
            text-align: center;
            line-height: 24px;
            font-size: 16px;
        }
        
        /* 列表符号样式预览容器 */
        .bullet-style-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        
        .bullet-style-option {
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
            transition: all 0.2s;
        }
        
        .bullet-style-option:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .bullet-style-option.active {
            border: 2px solid #4a6cf7;
            transform: scale(1.1);
        }
        
        /* 主题预览面板 */
        .theme-preview-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 280px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        
        .theme-preview-header {
            background: #4a6cf7;
            color: white;
            padding: 10px;
            margin: -15px -15px 15px -15px;
            border-radius: 10px 10px 0 0;
            position: relative;
        }
        
        .preview-close {
            position: absolute;
            right: 10px;
            top: 10px;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        
        .theme-preview-sample {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        
        .theme-preview-sample-header {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid;
        }
        
        .theme-preview-sample-text {
            font-size: 14px;
            line-height: 1.5;
        }
        
        .theme-preview-footer {
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                全行业调研助手
            </div>
            <h1>内容分析与导出工具</h1>
            <p class="description">将AI输出的分析内容整理并导出为精美图片，帮助你更好地理解用户需求、挖掘高付费人群、提炼卖点和创建引流内容。</p>
            
            <!-- 添加全局导出按钮 -->
            <div class="global-actions">
                <button class="export-all-button" onclick="exportAllLongImages()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    导出所有模块长图
                </button>
                <button class="export-all-button" style="margin-left: 10px; background-color: #2c3e50;" onclick="exportAllShortImages()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    导出所有模块短图
                </button>
                
                <!-- 添加全局风格选择 -->
                <div class="global-theme-selector" style="margin-top: 15px; text-align: center;">
                    <label for="global-theme" style="color: #666; margin-right: 10px;">全局风格设置:</label>
                    <select id="global-theme" onchange="applyGlobalTheme()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">选择一个全局风格</option>
                        <option value="default">默认风格</option>
                        <option value="vibrant">活力多彩</option>
                        <option value="warm">温暖橙棕</option>
                        <option value="fresh">清新自然</option>
                        <option value="tropical">热带风情</option>
                    </select>
                    <button id="preview-theme-button" style="margin-left: 10px; padding: 5px 10px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onclick="showThemePreview()">预览风格</button>
                </div>
                
                <!-- 添加全局列表符号样式设置 -->
                <div class="global-bullet-selector" style="margin-top: 15px; text-align: center;">
                    <label style="color: #666; display: block; margin-bottom: 5px;">列表符号风格:</label>
                    <div class="bullet-style-panel" id="global-bullet-style-panel">
                        <!-- 样式选项将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </header>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" data-tab="user-needs">用户需求分析</button>
                <button class="tab" data-tab="high-pay">高付费人群</button>
                <button class="tab" data-tab="search-intent">高意向搜索词</button>
                <button class="tab" data-tab="pre-needs">前置需求分析</button>
                <button class="tab" data-tab="low-competition">低竞争用户人群</button>
                <button class="tab" data-tab="selling-points">卖点分析</button>
                <button class="tab" data-tab="diff-service">差异化服务卖点</button>
                <button class="tab" data-tab="trust-words">信任话术分析</button>
                <button class="tab" data-tab="user-thoughts">用户心理分析</button>
                <button class="tab" data-tab="content-ideas">引流笔记思路</button>
                <button class="tab" data-tab="project-analysis">项目分析介绍</button>
            </div>

            <!-- 用户需求分析 -->
            <div class="tab-content active" id="user-needs">
                <div class="analysis-container">
                    <h2>用户需求分析</h2>
                    <div class="explanation">
                        这个工具是帮咱们找准用户真正想要啥的。就像买菜，得知道啥季节人们爱吃啥菜，才能备好货不被退。只有弄清楚用户心里的痒点在哪，咱们才能对症下药，少走弯路，做出真正有人愿意掏钱的产品和服务。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="user-needs-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="user-needs-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="user-needs-editor" placeholder="粘贴AI生成的用户需求分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('user-needs')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('user-needs')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('user-needs')">清空内容</button>
                    </div>
                    <div class="preview-area" id="user-needs-preview">
                        <h3>预览</h3>
                        <img id="user-needs-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 高付费人群 -->
            <div class="tab-content" id="high-pay">
                <div class="analysis-container">
                    <h2>高付费人群分析</h2>
                    <div class="explanation">
                        这是找出能交更多钱、不差钱的人群。就像卖水果，有人就爱买精品礼盒装的，不在乎多花点钱。了解这些人为啥掏钱痛快，啥时候最乐意花钱，咱们就能针对性地提供服务，赚得更多，还省了不少力气。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="high-pay-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="high-pay-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="high-pay-editor" placeholder="粘贴AI生成的高付费人群分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('high-pay')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('high-pay')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('high-pay')">清空内容</button>
                    </div>
                    <div class="preview-area" id="high-pay-preview">
                        <h3>预览</h3>
                        <img id="high-pay-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 高意向搜索词 -->
            <div class="tab-content" id="search-intent">
                <div class="analysis-container">
                    <h2>高意向搜索需求</h2>
                    <div class="explanation">
                        这是找出用户真正要下单时会搜的关键词。就像有人搜"今天能到的感冒药"和"感冒原因"，明显前者更急着买药。抓住这些词能帮咱们找到那些已经掏出钱包、就等着下单的人，省去大量白忙活，提高成交率。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="search-intent-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="search-intent-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="search-intent-editor" placeholder="粘贴AI生成的高意向搜索词分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('search-intent')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('search-intent')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('search-intent')">清空内容</button>
                    </div>
                    <div class="preview-area" id="search-intent-preview">
                        <h3>预览</h3>
                        <img id="search-intent-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 前置需求分析 -->
            <div class="tab-content" id="pre-needs">
                <div class="analysis-container">
                    <h2>前置需求分析</h2>
                    <div class="explanation">
                        这是找出用户产生购买行为前会有的一系列想法和行动。比如买房前，人们会先看学区、算首付、研究贷款政策等。了解这些环节，咱们就能提前布局，在竞争对手还没进场时就抢先接触客户，增加成交几率。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="pre-needs-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="pre-needs-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="pre-needs-editor" placeholder="粘贴AI生成的前置需求分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('pre-needs')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('pre-needs')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('pre-needs')">清空内容</button>
                    </div>
                    <div class="preview-area" id="pre-needs-preview">
                        <h3>预览</h3>
                        <img id="pre-needs-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 低竞争用户人群分析 -->
            <div class="tab-content" id="low-competition">
                <div class="analysis-container">
                    <h2>低竞争用户人群分析</h2>
                    <div class="explanation">
                        这个工具是帮我们找到更多的人群，比如月子茶这个产品，发现除了常规产妇外，还有"小月子"这个特殊人群（意外怀孕后不想要的人群），他们同样需要调养身体，而且因为心理压力更大，付费意愿可能更强。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="low-competition-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="low-competition-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="low-competition-editor" placeholder="粘贴AI生成的低竞争用户人群分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('low-competition')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('low-competition')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('low-competition')">清空内容</button>
                    </div>
                    <div class="preview-area" id="low-competition-preview">
                        <h3>预览</h3>
                        <img id="low-competition-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 卖点分析 -->
            <div class="tab-content" id="selling-points">
                <div class="analysis-container">
                    <h2>卖点分析</h2>
                    <div class="explanation">
                        这是找出产品最能打动人的亮点。就像卖西瓜，是"特甜"还是"特解渴"还是"无籽方便吃"更能吸引人？好的卖点能一句话就击中痛点、解决犹豫，让用户立刻掏钱，不再货比三家。这能大大提高转化率和复购率。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="selling-points-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="selling-points-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="selling-points-editor" placeholder="粘贴AI生成的卖点分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('selling-points')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('selling-points')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('selling-points')">清空内容</button>
                    </div>
                    <div class="preview-area" id="selling-points-preview">
                        <h3>预览</h3>
                        <img id="selling-points-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 差异化服务卖点分析 -->
            <div class="tab-content" id="diff-service">
                <div class="analysis-container">
                    <h2>差异化服务卖点分析</h2>
                    <div class="explanation">
                        这个工具是帮我们分析差异化卖点服务，比如旅游赛道提供看孩子服务让父母也能轻松享受旅行，或带客户去尝当地人排队的苍蝇小馆而非旅游团餐厅，这些差异化服务才是真正能拉开与竞争对手差距的关键。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="diff-service-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="diff-service-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="diff-service-editor" placeholder="粘贴AI生成的差异化服务卖点分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('diff-service')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('diff-service')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('diff-service')">清空内容</button>
                    </div>
                    <div class="preview-area" id="diff-service-preview">
                        <h3>预览</h3>
                        <img id="diff-service-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 信任话术分析 -->
            <div class="tab-content" id="trust-words">
                <div class="analysis-container">
                    <h2>信任话术分析</h2>
                    <div class="explanation">
                        做前端内容，不仅要让人看到我们，更要让人信任我们，建立信任是完成转化的核心。通过巧妙的话术，展示我们的专业性、经验和价值，能快速拉近与潜在客户的距离。这个工具能够给出很多信任话术的参考。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="trust-words-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="trust-words-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="trust-words-editor" placeholder="粘贴AI生成的信任话术分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('trust-words')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('trust-words')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('trust-words')">清空内容</button>
                    </div>
                    <div class="preview-area" id="trust-words-preview">
                        <h3>预览</h3>
                        <img id="trust-words-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 用户心理分析 -->
            <div class="tab-content" id="user-thoughts">
                <div class="analysis-container">
                    <h2>用户心理分析</h2>
                    <div class="explanation">
                        这是揭秘用户脑子里在想啥、担心啥、最在乎啥。好比相亲，了解对方喜好和顾虑才能投其所好。知道用户购买时的心理活动，咱们就能打消他们的疑虑、强化他们的期待，设计更有共鸣的营销内容，事半功倍。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="user-thoughts-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="user-thoughts-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="theme-style">风格:</label>
                                <select id="user-thoughts-theme">
                                    <option value="default">默认风格</option>
                                    <option value="vibrant">活力多彩</option>
                                    <option value="warm">温暖橙棕</option>
                                    <option value="fresh">清新自然</option>
                                    <option value="tropical">热带风情</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="user-thoughts-editor" placeholder="粘贴AI生成的用户心理分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('user-thoughts')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('user-thoughts')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('user-thoughts')">清空内容</button>
                    </div>
                    <div class="preview-area" id="user-thoughts-preview">
                        <h3>预览</h3>
                        <img id="user-thoughts-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 引流笔记思路 -->
            <div class="tab-content" id="content-ideas">
                <div class="analysis-container">
                    <h2>引流笔记思路</h2>
                    <div class="explanation">
                        这是设计能吸引目标用户、让他们主动来找你的内容创意。就像钓鱼，得用对鱼饵才能钓到想要的鱼。好的引流内容能激发用户的好奇心和分享欲，吸引他们主动私信咨询，顺利引导到私域继续深入沟通，提高转化率。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="content-ideas-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="content-ideas-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="content-ideas-editor" placeholder="粘贴AI生成的引流笔记思路内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('content-ideas')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('content-ideas')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('content-ideas')">清空内容</button>
                    </div>
                    <div class="preview-area" id="content-ideas-preview">
                        <h3>预览</h3>
                        <img id="content-ideas-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 项目分析 -->
            <div class="tab-content" id="project-analysis">
                <div class="analysis-container">
                    <h2>项目分析介绍</h2>
                    <div class="explanation">
                        这是对项目进行全面体检，看看它值不值得投入时间精力和金钱。就像创业前先考察市场，免得热情劲过后发现是个无底洞。好的项目分析能帮咱们看清项目的真实前景和风险，避免盲目跟风和投资亏损，做出更靠谱的决策。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="project-analysis-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="project-analysis-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="project-analysis-editor" placeholder="粘贴AI生成的项目分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('project-analysis')">预览3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('project-analysis')">预览长图</button>
                        <button class="button secondary" onclick="clearEditor('project-analysis')">清空内容</button>
                    </div>
                    <div class="preview-area" id="project-analysis-preview">
                        <h3>预览</h3>
                        <img id="project-analysis-image" alt="预览图">
                    </div>
                </div>
            </div>
        </div>

        <div id="canvas-container">
            <canvas id="image-canvas"></canvas>
        </div>
        
        <!-- 右侧多图预览区域 -->
        <div class="multi-preview-container" id="multi-preview">
            <button class="close-btn" onclick="closeMultiPreview()">×</button>
            <h3 id="preview-header">短图预览</h3>
            <div class="preview-thumbnails" id="preview-thumbnails">
                <!-- 缩略图会在这里动态生成 -->
            </div>
            <div class="preview-indicator" id="preview-indicator">1/1</div>
            <div class="current-preview">
                <div class="current-preview-title" id="current-preview-title">用户需求分析 - 第1页</div>
                <img id="current-preview-image" alt="当前预览图">
            </div>
            <div class="preview-controls">
                <button class="nav-button" id="prev-button" onclick="showPrevImage()" disabled>上一张</button>
                <button class="nav-button" id="next-button" onclick="showNextImage()" disabled>下一张</button>
            </div>
            <div class="preview-actions">
                <button class="button" id="download-current-button">下载当前图片</button>
                <button class="button secondary" id="download-all-button">下载全部图片</button>
            </div>
        </div>
        
        <div class="progress-indicator" id="progress-indicator">
            正在生成图片，请稍候...
        </div>
        
        <!-- 添加主题预览面板 -->
        <div class="theme-preview-panel" id="theme-preview-panel">
            <div class="theme-preview-header">
                <span id="preview-theme-name">主题预览</span>
                <button class="preview-close" onclick="hideThemePreview()">×</button>
            </div>
            <div class="theme-preview-sample" id="preview-sample-container">
                <div class="theme-preview-sample-header" id="preview-sample-header">
                    安全性与可靠性
                </div>
                <div class="theme-preview-sample-text" id="preview-sample-text">
                    安全是压倒一切的首要考虑因素。用户非常担心充电桩是否会出现过热、漏电、火灾等安全隐患。他们关注产品的认证、质保和安全保障机制，害怕"充着充着就着火了"或者"把整栋楼的电都给烧了"的情况出现。
                </div>
            </div>
            <div class="theme-preview-footer">
                <button style="padding: 5px 10px; background-color: #4a6cf7; color: white; border: none; border-radius: 4px; cursor: pointer;" onclick="applyPreviewTheme()">应用此风格</button>
            </div>
        </div>
    </div>

    <script>
        // 存储多图预览的图片数据
        let previewImages = [];
        let currentPreviewIndex = 0;
        
        // 颜色映射 - 保留但不再使用，改为随机颜色
        const colorMap = {
            'user-needs': '#4a6cf7',    // 蓝色
            'high-pay': '#8c44f7',      // 紫色
            'search-intent': '#2ecc71',  // 绿色
            'pre-needs': '#e74c3c',     // 红色
            'low-competition': '#16a085', // 青色
            'selling-points': '#f39c12', // 橙色
            'diff-service': '#d35400',  // 深橙色
            'trust-words': '#27ae60',   // 深绿色
            'user-thoughts': '#3498db',  // 天蓝色
            'content-ideas': '#9b59b6',  // 紫红色
            'project-analysis': '#1abc9c' // 青绿色
        };
        
        // 主题样式映射
        const themeStyles = {
            'default': {
                primary: null, // 使用默认的colorMap
                background: '#ffffff',
                text: '#333333',
                titleBackground: 'gradient', // 使用渐变
                titleText: '#ffffff'
            },
            'vibrant': {
                primary: {
                    'user-needs': '#FF0266',
                    'high-pay': '#FF5722',
                    'search-intent': '#FFC107',
                    'pre-needs': '#8BC34A',
                    'low-competition': '#00BCD4',
                    'selling-points': '#2196F3',
                    'diff-service': '#673AB7',
                    'trust-words': '#E91E63',
                    'user-thoughts': '#F44336',
                    'content-ideas': '#CDDC39',
                    'project-analysis': '#009688'
                },
                background: '#ffffff',
                text: '#424242',
                titleBackground: 'gradient',
                titleText: '#ffffff'
            },
            'warm': {
                primary: {
                    'user-needs': '#FF9800',
                    'high-pay': '#FF7043',
                    'search-intent': '#FFB74D',
                    'pre-needs': '#FFA726',
                    'low-competition': '#FB8C00',
                    'selling-points': '#F57C00',
                    'diff-service': '#EF6C00',
                    'trust-words': '#E65100',
                    'user-thoughts': '#D84315',
                    'content-ideas': '#BF360C',
                    'project-analysis': '#FF5722'
                },
                background: '#FFF8E1',
                text: '#5D4037',
                titleBackground: 'gradient',
                titleText: '#ffffff'
            },
            'fresh': {
                primary: {
                    'user-needs': '#4CAF50',
                    'high-pay': '#8BC34A',
                    'search-intent': '#CDDC39',
                    'pre-needs': '#009688',
                    'low-competition': '#3F51B5',
                    'selling-points': '#00BCD4',
                    'diff-service': '#2196F3',
                    'trust-words': '#00796B',
                    'user-thoughts': '#43A047',
                    'content-ideas': '#7CB342',
                    'project-analysis': '#26A69A'
                },
                background: '#F1F8E9',
                text: '#33691E',
                titleBackground: 'gradient',
                titleText: '#ffffff'
            },
            'tropical': {
                primary: {
                    'user-needs': '#FF4D4D',
                    'high-pay': '#FF9A00',
                    'search-intent': '#FFEA00',
                    'pre-needs': '#00C853',
                    'low-competition': '#00E5FF',
                    'selling-points': '#D500F9',
                    'diff-service': '#AA00FF',
                    'trust-words': '#00E676',
                    'user-thoughts': '#FFC400',
                    'content-ideas': '#FF3D00',
                    'project-analysis': '#00B0FF'
                },
                background: '#FFFDE7',
                text: '#3E2723',
                titleBackground: 'gradient',
                titleText: '#ffffff'
            }
        };
        
        // 标题映射
        const titleMap = {
            'user-needs': '用户需求分析',
            'high-pay': '高付费人群分析',
            'search-intent': '高意向搜索需求',
            'pre-needs': '前置需求分析',
            'low-competition': '低竞争用户人群分析',
            'selling-points': '卖点分析',
            'diff-service': '差异化服务卖点分析',
            'trust-words': '信任话术分析',
            'user-thoughts': '用户心理分析',
            'content-ideas': '引流笔记思路',
            'project-analysis': '项目分析介绍'
        };
        
        // 解释映射 - 更通俗的版本
        const explanationMap = {
            'user-needs': '这个工具是帮咱们找准用户真正想要啥的。就像买菜，得知道啥季节人们爱吃啥菜，才能备好货不被退。只有弄清楚用户心里的痒点在哪，咱们才能对症下药，少走弯路，做出真正有人愿意掏钱的产品和服务。',
            'high-pay': '这是找出能交更多钱、不差钱的人群。就像卖水果，有人就爱买精品礼盒装的，不在乎多花点钱。了解这些人为啥掏钱痛快，啥时候最乐意花钱，咱们就能针对性地提供服务，赚得更多，还省了不少力气。',
            'search-intent': '这是找出用户真正要下单时会搜的关键词。就像有人搜"今天能到的感冒药"和"感冒原因"，明显前者更急着买药。抓住这些词能帮咱们找到那些已经掏出钱包、就等着下单的人，省去大量白忙活，提高成交率。',
            'pre-needs': '这是找出用户产生购买行为前会有的一系列想法和行动。比如买房前，人们会先看学区、算首付、研究贷款政策等。了解这些环节，咱们就能提前布局，在竞争对手还没进场时就抢先接触客户，增加成交几率。',
            'low-competition': '这个工具是帮我们找到更多的人群，比如月子茶这个产品，发现除了常规产妇外，还有"小月子"这个特殊人群（意外怀孕后不想要的人群），他们同样需要调养身体，而且因为心理压力更大，付费意愿可能更强。',
            'selling-points': '这是找出产品最能打动人的亮点。就像卖西瓜，是"特甜"还是"特解渴"还是"无籽方便吃"更能吸引人？好的卖点能一句话就击中痛点、解决犹豫，让用户立刻掏钱，不再货比三家。这能大大提高转化率和复购率。',
            'diff-service': '这个工具是帮我们分析差异化卖点服务，比如旅游赛道提供看孩子服务让父母也能轻松享受旅行，或带客户去尝当地人排队的苍蝇小馆而非旅游团餐厅，这些差异化服务才是真正能拉开与竞争对手差距的关键。',
            'trust-words': '做前端内容，不仅要让人看到我们，更要让人信任我们，建立信任是完成转化的核心。通过巧妙的话术，展示我们的专业性、经验和价值，能快速拉近与潜在客户的距离。这个工具能够给出很多信任话术的参考。',
            'user-thoughts': '这是揭秘用户脑子里在想啥、担心啥、最在乎啥。好比相亲，了解对方喜好和顾虑才能投其所好。知道用户购买时的心理活动，咱们就能打消他们的疑虑、强化他们的期待，设计更有共鸣的营销内容，事半功倍。',
            'content-ideas': '这是设计能吸引目标用户、让他们主动来找你的内容创意。就像钓鱼，得用对鱼饵才能钓到想要的鱼。好的引流内容能激发用户的好奇心和分享欲，吸引他们主动私信咨询，顺利引导到私域继续深入沟通，提高转化率。',
            'project-analysis': '这是对项目进行全面体检，看看它值不值得投入时间精力和金钱。就像创业前先考察市场，免得热情劲过后发现是个无底洞。好的项目分析能帮咱们看清项目的真实前景和风险，避免盲目跟风和投资亏损，做出更靠谱的决策。'
        };
        
        // 获取颜色
        function getColorForTab(tabId) {
            // 先检查是否有用户选择的主题
            const themeSelect = document.getElementById(`${tabId}-theme`);
            if (themeSelect) {
                const selectedTheme = themeSelect.value;
                const themeStyle = themeStyles[selectedTheme];
                
                if (themeStyle && themeStyle.primary) {
                    if (themeStyle.primary[tabId]) {
                        return themeStyle.primary[tabId];
                    }
                }
            }
            
            // 如果没有找到用户主题或该主题没有为此选项卡定义颜色，则返回默认颜色
            return colorMap[tabId] || '#4a6cf7';
        }
        
        // 获取背景颜色
        function getBackgroundColor(tabId) {
            const themeSelect = document.getElementById(`${tabId}-theme`);
            if (themeSelect) {
                const selectedTheme = themeSelect.value;
                const themeStyle = themeStyles[selectedTheme];
                
                if (themeStyle && themeStyle.background) {
                    return themeStyle.background;
                }
            }
            
            return '#ffffff'; // 默认背景色
        }
        
        // 获取文本颜色
        function getTextColor(tabId) {
            const themeSelect = document.getElementById(`${tabId}-theme`);
            if (themeSelect) {
                const selectedTheme = themeSelect.value;
                const themeStyle = themeStyles[selectedTheme];
                
                if (themeStyle && themeStyle.text) {
                    return themeStyle.text;
                }
            }
            
            return '#333333'; // 默认文本颜色
        }
        
        // 获取标题背景样式类型
        function getTitleBackgroundStyle(tabId) {
            const themeSelect = document.getElementById(`${tabId}-theme`);
            if (themeSelect) {
                const selectedTheme = themeSelect.value;
                const themeStyle = themeStyles[selectedTheme];
                
                if (themeStyle && themeStyle.titleBackground) {
                    return themeStyle.titleBackground;
                }
            }
            
            return 'gradient'; // 默认使用渐变
        }
        
        // 获取标题文本颜色
        function getTitleTextColor(tabId) {
            const themeSelect = document.getElementById(`${tabId}-theme`);
            if (themeSelect) {
                const selectedTheme = themeSelect.value;
                const themeStyle = themeStyles[selectedTheme];
                
                if (themeStyle && themeStyle.titleText) {
                    return themeStyle.titleText;
                }
            }
            
            return '#ffffff'; // 默认标题文字颜色
        }
        
        // 获取标题
        function getTitle(tabId) {
            return titleMap[tabId] || '分析报告';
        }
        
        // 获取解释
        function getExplanation(tabId) {
            return explanationMap[tabId] || '';
        }
        
        // 获取用户设置的字体大小
        function getFontSize(tabId) {
            const fontSizeSelect = document.getElementById(`${tabId}-font-size`);
            return parseInt(fontSizeSelect.value);
        }
        
        // 获取用户设置的行高
        function getLineHeight(tabId) {
            const lineHeightSelect = document.getElementById(`${tabId}-line-height`);
            return parseInt(lineHeightSelect.value);
        }
        
        // 生成随机颜色
        function getRandomColor() {
            // 生成较为柔和的颜色，避免太亮或太暗的颜色
            const r = Math.floor(Math.random() * 156) + 50; 
            const g = Math.floor(Math.random() * 156) + 50;
            const b = Math.floor(Math.random() * 156) + 50;
            return `rgb(${r}, ${g}, ${b})`;
        }

        // 初始化标签切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // 清空编辑器内容
        function clearEditor(tabId) {
            const editor = document.getElementById(`${tabId}-editor`);
            editor.value = '';
            document.getElementById(`${tabId}-preview`).style.display = 'none';
            localStorage.removeItem(`marketingTool-${tabId}`);
        }

        // 关闭右侧多图预览
        function closeMultiPreview() {
            document.getElementById('multi-preview').style.display = 'none';
        }

        // 更新右侧多图预览的缩略图
        function updatePreviewThumbnails() {
            const thumbnailsContainer = document.getElementById('preview-thumbnails');
            thumbnailsContainer.innerHTML = '';
            
            previewImages.forEach((image, index) => {
                const thumbnail = document.createElement('img');
                thumbnail.src = image.url;
                thumbnail.className = 'preview-thumbnail';
                if (index === currentPreviewIndex) {
                    thumbnail.classList.add('active');
                }
                thumbnail.onclick = () => showPreviewImage(index);
                thumbnailsContainer.appendChild(thumbnail);
            });
        }
        
        // 显示指定索引的预览图片
        function showPreviewImage(index) {
            if (index < 0 || index >= previewImages.length) return;
            
            currentPreviewIndex = index;
            const currentImage = previewImages[index];
            
            // 更新当前预览图片
            const previewImage = document.getElementById('current-preview-image');
            previewImage.src = currentImage.url;
            
            // 更新标题
            const previewTitle = document.getElementById('current-preview-title');
            previewTitle.textContent = `${currentImage.title} - 第${currentImage.page}页`;
            
            // 更新指示器
            const indicator = document.getElementById('preview-indicator');
            indicator.textContent = `${index + 1}/${previewImages.length}`;
            
            // 更新导航按钮状态
            document.getElementById('prev-button').disabled = index === 0;
            document.getElementById('next-button').disabled = index === previewImages.length - 1;
            
            // 更新缩略图选中状态
            const thumbnails = document.querySelectorAll('.preview-thumbnail');
            thumbnails.forEach((thumbnail, i) => {
                if (i === index) {
                    thumbnail.classList.add('active');
                } else {
                    thumbnail.classList.remove('active');
                }
            });
            
            // 更新下载按钮
            const downloadButton = document.getElementById('download-current-button');
            downloadButton.onclick = () => downloadImage(currentImage.url, `${currentImage.title}_第${currentImage.page}页.png`);
        }
        
        // 显示上一张图片
        function showPrevImage() {
            if (currentPreviewIndex > 0) {
                showPreviewImage(currentPreviewIndex - 1);
            }
        }
        
        // 显示下一张图片
        function showNextImage() {
            if (currentPreviewIndex < previewImages.length - 1) {
                showPreviewImage(currentPreviewIndex + 1);
            }
        }
        
        // 添加图片到多图预览
        function addImageToMultiPreview(imageData, title, page, totalPages) {
            // 添加新图片
            previewImages.push({
                url: imageData,
                title: title,
                page: page,
                totalPages: totalPages
            });
            
            // 更新缩略图
            updatePreviewThumbnails();
            
            // 如果是第一张图片，显示它
            if (previewImages.length === 1) {
                showPreviewImage(0);
            }
            
            // 显示右侧多图预览
            document.getElementById('multi-preview').style.display = 'flex';
            
            // 更新标题 - 检查是否为长图预览
            const previewHeader = document.getElementById('preview-header');
            if (title.includes('长图')) {
                previewHeader.textContent = '长图预览';
            } else {
                previewHeader.textContent = '短图预览';
            }
            
            // 更新下载全部按钮
            document.getElementById('download-all-button').onclick = downloadAllImages;
        }
        
        // 下载所有预览图片
        function downloadAllImages() {
            if (previewImages.length === 0) return;
            
            // 单张图片直接下载
            if (previewImages.length === 1) {
                const image = previewImages[0];
                downloadImage(image.url, `${image.title}_第${image.page}页.png`);
                return;
            }
            
            // 多张图片打包为ZIP
            const zip = new JSZip();
            
            // 添加所有图片到ZIP
            const promises = previewImages.map((image, index) => {
                return fetch(image.url)
                    .then(res => res.blob())
                    .then(blob => {
                        zip.file(`${image.title}_第${image.page}页.png`, blob);
                    });
            });
            
            // 所有图片添加完成后生成ZIP
            Promise.all(promises).then(() => {
                zip.generateAsync({type: 'blob'}).then(function(content) {
                    // 下载ZIP文件
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = '短图集.zip';
                    link.click();
                });
            });
        }

        // 文本换行函数
        function wrapText(context, text, x, y, maxWidth, lineHeight) {
            let lines = [];
            let currentLine = '';
            
            // 处理中文和英文混合内容
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const testWidth = context.measureText(currentLine + char).width;
                
                if (testWidth > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = char;
                } else {
                    currentLine += char;
                }
            }
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            // 绘制每一行
            let newY = y;
            for (let i = 0; i < lines.length; i++) {
                context.fillText(lines[i], x, newY);
                newY += lineHeight;
            }
            
            return newY;
        }
        
        // 移除增强版文本换行函数
        // ... existing code ...

        // 下载图片
        function downloadImage(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            link.click();
        }
        
        // 清空多图预览
        function clearMultiPreview() {
            previewImages = [];
            currentPreviewIndex = 0;
            document.getElementById('preview-thumbnails').innerHTML = '';
            document.getElementById('current-preview-image').src = '';
            document.getElementById('current-preview-title').textContent = '';
            document.getElementById('preview-indicator').textContent = '0/0';
            document.getElementById('prev-button').disabled = true;
            document.getElementById('next-button').disabled = true;
            document.getElementById('multi-preview').style.display = 'none';
        }
        
        // 生成图片
        function generateImage(tabId) {
            try {
                const editor = document.getElementById(`${tabId}-editor`);
                const text = editor.value.trim();
                
                if (!text) {
                    alert('请先输入或粘贴内容');
                    return;
                }
                
                const progressIndicator = document.getElementById('progress-indicator');
                progressIndicator.style.display = 'block';
                progressIndicator.textContent = '正在生成图片，请稍候...';
                
                // 清空多图预览，准备添加新图片
                clearMultiPreview();
                
                // 清理前缀和markdown标记
                let cleanedText = text.replace(/^好的[，,].*?[。\n]/, '');
                cleanedText = cleanedText.replace(/^我来分析.*?[。\n]/, '');
                cleanedText = cleanedText.replace(/##/g, ''); // 去除所有##标记
                cleanedText = cleanedText.replace(/\n#+\s*/g, '\n'); // 去除可能的markdown标题标记
                
                // 创建画布
                const canvas = document.getElementById('image-canvas');
                const width = 900;
                const height = 1200;
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                
                // 获取用户设置
                const fontSize = getFontSize(tabId);
                const lineHeight = getLineHeight(tabId);
                
                // 准备分页
                const paragraphs = cleanedText.split('\n');
                const pages = [];
                let currentPage = [];
                let estimatedHeight = 0;
                const lineHeightEstimate = lineHeight;
                
                // 获取解释文本
                const explanation = getExplanation(tabId);
                
                // 估计分页，确保每一页都有解释文本
                let explanationHeight = 0;
                if (explanation) {
                    const explanationLines = Math.ceil(explanation.length * (fontSize-2) / (width - 120));
                    explanationHeight = explanationLines * (lineHeight-6) + 30; // 增加一些padding
                }
                
                // 处理正文内容和分页
                for (let i = 0; i < paragraphs.length; i++) {
                    const para = paragraphs[i].trim();
                    if (para === '') {
                        currentPage.push('');
                        estimatedHeight += lineHeightEstimate * 0.5;
                        continue;
                    }
                    
                    // 估算段落高度
                    let paraHeight;
                    if (/^\d+[\.\、]/.test(para)) {
                        // 数字标题
                        const lines = Math.ceil(para.length * fontSize / (width - 100));
                        paraHeight = lines * lineHeightEstimate * 1.5;
                    } else if (/^\s*[-•*⦿◉◆◇○●✓☑]/.test(para)) {
                        // 无序列表项
                        const lines = Math.ceil(para.length * fontSize / (width - 100));
                        paraHeight = lines * lineHeightEstimate * 1.2;
                    } else if (para.includes('：') && para.indexOf('：') < 30) {
                        // 冒号标题
                        const lines = Math.ceil(para.length * fontSize / (width - 100));
                        paraHeight = lines * lineHeightEstimate * 1.2;
                    } else {
                        // 普通段落
                        const lines = Math.ceil(para.length * fontSize / (width - 100));
                        paraHeight = lines * lineHeightEstimate;
                    }
                    
                    // 考虑解释文本的高度，确保每页都有足够空间
                    // 修改：增加页面容量，页面高度提高到92%，红线位置大约是底部的92%
                    const maxPageHeight = height * 0.92 - explanationHeight - 50;
                    
                    // 检查是否需要新页
                    if (estimatedHeight + paraHeight > maxPageHeight && currentPage.length > 0) {
                        // 获取当前页最后几行内容作为下一页的开始，以重叠方式防止内容丢失
                        const overlapLines = Math.min(2, currentPage.length);
                        const overlapContent = currentPage.slice(-overlapLines);
                        
                        // 将解释文本作为特殊标记添加到每一页
                        currentPage.unshift("#EXPLANATION#" + explanation);
                        
                        pages.push(currentPage);
                        
                        // 下一页以重叠内容开始，再添加新段落
                        currentPage = [...overlapContent, para];
                        
                        // 重新计算高度，考虑重叠内容
                        estimatedHeight = paraHeight;
                        for (const overlapPara of overlapContent) {
                            if (overlapPara.trim() === '') {
                                estimatedHeight += lineHeightEstimate * 0.5;
                            } else if (/^\d+[\.\、]/.test(overlapPara.trim())) {
                                const lines = Math.ceil(overlapPara.length * fontSize / (width - 100));
                                estimatedHeight += lines * lineHeightEstimate * 1.5;
                            } else if (/^\s*[-•*⦿◉◆◇○●✓☑]/.test(overlapPara.trim())) {
                                // 无序列表项
                                const lines = Math.ceil(overlapPara.length * fontSize / (width - 100));
                                estimatedHeight += lines * lineHeightEstimate * 1.2;
                            } else if (overlapPara.includes('：') && overlapPara.indexOf('：') < 30) {
                                const lines = Math.ceil(overlapPara.length * fontSize / (width - 100));
                                estimatedHeight += lines * lineHeightEstimate * 1.2;
                            } else {
                                const lines = Math.ceil(overlapPara.length * fontSize / (width - 100));
                                estimatedHeight += lines * lineHeightEstimate;
                            }
                        }
                    } else {
                        currentPage.push(para);
                        estimatedHeight += paraHeight;
                    }
                }
                
                if (currentPage.length > 0) {
                    // 确保最后一页也有解释文本
                    currentPage.unshift("#EXPLANATION#" + explanation);
                    pages.push(currentPage);
                }
                
                if (pages.length === 0) {
                    pages.push(["#EXPLANATION#" + explanation, ...paragraphs]);
                }
                
                console.log(`内容将分为 ${pages.length} 页`);
                
                // 创建ZIP（如果有多页）
                let zip = null;
                if (pages.length > 1) {
                    zip = new JSZip();
                }
                
                // 处理每页
                let pageIndex = 0;
                const pagePadding = 30; // 页面间的重叠区域，防止内容丢失
                
                processNextPage();
                
                function processNextPage() {
                    if (pageIndex >= pages.length) {
                        // 完成所有页面
                        if (zip) {
                            document.getElementById('multi-preview').style.display = 'flex';
                            // 只打包不下载，让用户从预览区手动下载
                            zip.generateAsync({type: "blob"}).then(function(content) {
                                // 存储ZIP对象以供用户手动下载
                                const zipBlob = content;
                                const zipUrl = URL.createObjectURL(zipBlob);
                                // 更新下载全部按钮，点击时才下载ZIP
                                document.getElementById('download-all-button').onclick = function() {
                                    const link = document.createElement('a');
                                    link.href = zipUrl;
                                    link.download = `${getTitle(tabId)}.zip`;
                                    link.click();
                                };
                            });
                        } else {
                            document.getElementById('multi-preview').style.display = 'flex';
                        }
                        progressIndicator.style.display = 'none';
                        return;
                    }
                    
                    // 获取当前页内容
                    const pageContent = pages[pageIndex];
                    const pageNum = pageIndex + 1;
                    
                    // 清除画布
                    ctx.clearRect(0, 0, width, height);
                    
                    // 获取主题样式
                    const themeColor = getColorForTab(tabId);
                    const bgColor = getBackgroundColor(tabId);
                    const textColor = getTextColor(tabId);
                    const titleBgStyle = getTitleBackgroundStyle(tabId);
                    const titleTextColor = getTitleTextColor(tabId);
                    
                    // 绘制背景
                    ctx.fillStyle = bgColor;
                    ctx.fillRect(0, 0, width, height);
                    
                    // 绘制标题背景
                    if (titleBgStyle === 'gradient') {
                        // 顶部渐变
                        const gradientHeight = height * 0.2; // 恢复原始渐变高度
                        const gradient = ctx.createLinearGradient(0, 0, 0, gradientHeight);
                        gradient.addColorStop(0, themeColor);  
                        gradient.addColorStop(1, bgColor);
                        ctx.fillStyle = gradient;
                        ctx.fillRect(0, 0, width, gradientHeight);
                    } else {
                        // 纯色标题背景
                        ctx.fillStyle = themeColor;
                        ctx.fillRect(0, 0, width, height * 0.15);
                    }
                    
                    // 标题
                    ctx.fillStyle = titleTextColor;
                    ctx.font = 'bold 40px Arial, "Microsoft YaHei", "微软雅黑"';
                    const title = getTitle(tabId);
                    ctx.fillText(title, 50, 80);
                    
                    // 页码（如果多页）
                    if (pages.length > 1) {
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '24px Arial, "Microsoft YaHei", "微软雅黑"';
                        ctx.fillText(`${pageNum}/${pages.length}`, width - 100, 80);
                    }
                    
                    // 直接在标题下方添加解释文本，不限制文本长度
                    if (explanation) {
                        // 不添加背景，直接在渐变区域写文字
                        ctx.fillStyle = '#333333'; // 恢复为深色文本
                        ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        
                        // 使用原始的文本包装函数
                        wrapText(ctx, explanation, 50, 120, width - 100, lineHeight);
                    }
                    
                    // 渲染内容 - 从渐变区域下方开始
                    const maxWidth = width - 100;
                    let y = height * 0.2 + 20; // 恢复原始内容起始位置
                    
                    // 解释文本是否已渲染的标志
                    let hasExplanation = false;
                    
                    // 处理页面内容
                    for (const paragraph of pageContent) {
                        // 如果是解释文本，跳过，因为我们已经在标题下方显示了
                        if (paragraph.startsWith("#EXPLANATION#")) {
                            hasExplanation = true;
                            continue;
                        }
                        
                        if (paragraph.trim() === '') {
                            y += lineHeight * 0.5;
                            continue;
                        }
                        
                        // 特殊格式处理
                        // 1. 检查是否为第一段内容，保持正常字体大小，不要变成标题大小
                        if (!hasExplanation && !paragraph.startsWith('用户角度的心声：')) {
                            // 使用普通段落样式
                            ctx.fillStyle = '#333333';
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            
                            y = wrapText(ctx, paragraph.trim(), 50, y, maxWidth, lineHeight);
                            y += lineHeight * 0.3;
                            
                            hasExplanation = true; // 防止其他段落成为大标题
                            continue;
                        }
                        
                        // 2. 数字标题 (如 "1. 标题")
                        if (/^\d+[\.\、]/.test(paragraph.trim())) {
                            // 使用主题色而非随机色，保持与长图一致
                            ctx.fillStyle = themeColor;
                            ctx.font = `bold ${fontSize+6}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            y = wrapText(ctx, paragraph.trim(), 50, y, maxWidth, lineHeight * 1.2);
                            y += lineHeight * 0.5;
                            
                            // 重置样式
                            ctx.fillStyle = '#333333';
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        } 
                        // 3. 无序列表项 (以 - 或 • 或 * 等符号开头)
                        else if (/^\s*[-•*⦿◉◆◇○●✓☑]/.test(paragraph.trim())) {
                            const trimmedPara = paragraph.trim();
                            
                            // 使用全局定义的列表符号
                            let bulletSymbol = getBulletSymbol() + ' ';
                            const content = trimmedPara.replace(/^[-•*⦿◉◆◇○●✓☑]\s*/, '');
                            
                            // 使用主题色绘制符号，如果该符号可着色
                            if (isBulletColorful()) {
                                ctx.fillStyle = themeColor;
                            } else {
                                ctx.fillStyle = '#333333'; // 对于表情符号使用黑色
                            }
                            
                            ctx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            ctx.fillText(bulletSymbol, 50, y);
                            
                            const bulletWidth = ctx.measureText(bulletSymbol).width;
                            
                            // 绘制文本内容
                            ctx.fillStyle = '#333333';
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            y = wrapText(ctx, content, 50 + bulletWidth, y, maxWidth - bulletWidth, lineHeight);
                            y += lineHeight * 0.3;
                        }
                        // 4. 用户角度的心声部分 - 使用统一样式
                        else if (paragraph.trim().startsWith('用户角度的心声：')) {
                            // 分离冒号前后的部分
                            const colonIndex = paragraph.indexOf('：');
                            const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                            const afterColon = paragraph.substring(colonIndex + 1);
                            
                            // 使用统一颜色
                            ctx.fillStyle = '#333333';
                            ctx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            ctx.fillText(beforeColon, 50, y);
                            
                            const beforeWidth = ctx.measureText(beforeColon).width;
                            
                            // 冒号后的部分使用普通样式
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            
                            // 如果冒号后内容较长，另起一行
                            if (afterColon.length > 20 || beforeWidth + ctx.measureText(afterColon).width > maxWidth) {
                                y += lineHeight;
                                y = wrapText(ctx, afterColon, 50, y, maxWidth, lineHeight);
                            } else {
                                // 短内容接着冒号后显示
                                ctx.fillText(afterColon, 50 + beforeWidth, y);
                                y += lineHeight;
                            }
                            
                            // 重置样式
                            ctx.fillStyle = '#333333';
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        }
                        // 5. 冒号标题 (如 "为什么会有这个需求：" 或 "针对这样的需求我们应该怎么做：")
                        else if (paragraph.includes('：') && paragraph.indexOf('：') < 30) {
                            // 分离冒号前后的部分
                            const colonIndex = paragraph.indexOf('：');
                            const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                            const afterColon = paragraph.substring(colonIndex + 1);
                            
                            // 使用主题色而非随机色
                            ctx.fillStyle = '#333333';
                            ctx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            const beforeWidth = ctx.measureText(beforeColon).width;
                            ctx.fillText(beforeColon, 50, y);
                            
                            // 冒号后的部分使用普通样式
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            
                            // 如果冒号后的内容较长或包含逗号等，另起一行
                            if (afterColon.length > 30 || afterColon.includes('，') || beforeWidth + ctx.measureText(afterColon).width > maxWidth) {
                                y += lineHeight;
                                y = wrapText(ctx, afterColon, 50, y, maxWidth, lineHeight);
                            } else {
                                // 短内容接着冒号后显示
                                ctx.fillText(afterColon, 50 + beforeWidth, y);
                                y += lineHeight;
                            }
                        }
                        // 6. 普通段落
                        else {
                            ctx.fillStyle = '#333333';
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            y = wrapText(ctx, paragraph.trim(), 50, y, maxWidth, lineHeight);
                            y += lineHeight * 0.3;
                        }
                    }
                    
                    // 获取图像数据
                    const imageData = canvas.toDataURL('image/png');
                    
                    // 显示第一页预览
                    if (pageIndex === 0) {
                        const previewArea = document.getElementById(`${tabId}-preview`);
                        previewArea.style.display = 'flex';
                        const previewImage = document.getElementById(`${tabId}-image`);
                        previewImage.src = imageData;
                        
                        // 页数信息
                        if (pages.length > 1) {
                            let pageInfoElem = document.getElementById(`${tabId}-page-info`);
                            if (!pageInfoElem) {
                                pageInfoElem = document.createElement('div');
                                pageInfoElem.id = `${tabId}-page-info`;
                                pageInfoElem.className = 'page-info';
                                previewArea.appendChild(pageInfoElem);
                            }
                            pageInfoElem.textContent = `共 ${pages.length} 页，第 1 页显示在预览中`;
                        }
                    }
                    
                    // 添加到右侧多图预览
                    addImageToMultiPreview(imageData, getTitle(tabId), pageNum, pages.length);
                    
                    // 如果有多页，将图片添加到ZIP
                    if (zip) {
                        // 转为Blob
                        fetch(imageData)
                            .then(res => res.blob())
                            .then(blob => {
                                // 添加到ZIP
                                zip.file(`${getTitle(tabId)}_第${pageNum}页.png`, blob);
                                
                                // 处理下一页
                                pageIndex++;
                                setTimeout(processNextPage, 50);
                            });
                    } else {
                        // 单页
                        pageIndex++;
                        setTimeout(processNextPage, 50);
                    }
                }
            } catch (error) {
                console.error('生成图片时出错:', error);
                document.getElementById('progress-indicator').style.display = 'none';
                alert('生成图片时出错: ' + error.message);
            }
        }
        
// 生成长图（将所有内容拼接成一张图）
function generateLongImage(tabId) {
    try {
        const progressIndicator = document.getElementById('progress-indicator');
        progressIndicator.style.display = 'block';
        progressIndicator.textContent = '正在生成长图，请稍候...';
        
        const editor = document.getElementById(`${tabId}-editor`);
        const text = editor.value.trim();
        
        if (!text) {
            alert('请先输入或粘贴内容');
            progressIndicator.style.display = 'none';
            return;
        }
        
        // 清理前缀和markdown标记
        let cleanedText = text.replace(/^好的[，,].*?[。\n]/, '');
        cleanedText = cleanedText.replace(/^我来分析.*?[。\n]/, '');
        cleanedText = cleanedText.replace(/##/g, ''); // 去除所有##标记
        cleanedText = cleanedText.replace(/\n#+\s*/g, '\n'); // 去除可能的markdown标题标记
        
        // 使用setTimeout确保UI更新，并防止浏览器挂起
        setTimeout(() => {
            try {
                // 创建临时画布用于测量和绘制
                const canvas = document.getElementById('image-canvas');
                const width = 900;
                
                // 设置临时画布大小 - 先设一个足够大的尺寸
                canvas.width = width;
                canvas.height = 8000; // 临时设置一个非常大的高度，确保足够容纳内容
                
                const ctx = canvas.getContext('2d');
                
                // 获取用户设置
                const fontSize = getFontSize(tabId);
                const lineHeight = getLineHeight(tabId);
                
                // 获取解释文本
                const explanation = getExplanation(tabId);
                const themeColor = getColorForTab(tabId);
                const title = getTitle(tabId);
                
                // 准备段落
                const paragraphs = cleanedText.split('\n');
                
                // 填充白色背景
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, width, 8000);
                
                // 计算标题区域高度并增加
                const headerHeight = 240; // 恢复原始标题区域高度
                
                // 绘制顶部渐变
                const gradient = ctx.createLinearGradient(0, 0, 0, headerHeight);
                gradient.addColorStop(0, themeColor);  
                gradient.addColorStop(0.5, '#ffffff');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, headerHeight);
                
                // 绘制标题
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 40px Arial, "Microsoft YaHei", "微软雅黑"';
                ctx.fillText(title, 50, 80);
                
                // 绘制解释文本
                if (explanation) {
                    ctx.fillStyle = '#333333'; // 恢复为深色文本
                    ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                    
                    // 使用原始的文本包装函数
                    wrapText(ctx, explanation, 50, 120, width - 100, lineHeight);
                }
                
                // 开始绘制内容
                let y = headerHeight;
                const maxWidth = width - 100;
                
                // 绘制所有段落并记录实际高度
                for (const paragraph of paragraphs) {
                    if (paragraph.trim() === '') {
                        y += lineHeight * 0.5;
                        continue;
                    }
                    
                    // 特殊格式处理
                    // 1. 数字标题 (如 "1. 标题")
                    if (/^\d+[\.\、]/.test(paragraph.trim())) {
                        ctx.fillStyle = themeColor;
                        ctx.font = `bold ${fontSize+6}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        y = wrapText(ctx, paragraph.trim(), 50, y, maxWidth, lineHeight * 1.2);
                        y += lineHeight * 0.5;
                        
                        // 重置样式
                        ctx.fillStyle = '#333333';
                        ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                    } 
                    // 2. 用户角度的心声部分
                    else if (paragraph.trim().startsWith('用户角度的心声：')) {
                        // 分离冒号前后的部分
                        const colonIndex = paragraph.indexOf('：');
                        const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                        const afterColon = paragraph.substring(colonIndex + 1);
                        
                        // 冒号前的部分使用普通加粗样式
                        ctx.fillStyle = '#333333';
                        ctx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        ctx.fillText(beforeColon, 50, y);
                        
                        const beforeWidth = ctx.measureText(beforeColon).width;
                        
                        // 冒号后的部分使用普通样式
                        ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        
                        // 如果冒号后内容较长，另起一行
                        if (afterColon.length > 20 || beforeWidth + ctx.measureText(afterColon).width > maxWidth) {
                            y += lineHeight;
                            y = wrapText(ctx, afterColon, 50, y, maxWidth, lineHeight);
                        } else {
                            // 短内容接着冒号后显示
                            ctx.fillText(afterColon, 50 + beforeWidth, y);
                            y += lineHeight;
                        }
                        
                        // 重置样式
                        ctx.fillStyle = '#333333';
                        ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                    }
                    // 3. 冒号标题
                    else if (paragraph.includes('：') && paragraph.indexOf('：') < 30) {
                        // 分离冒号前后的部分
                        const colonIndex = paragraph.indexOf('：');
                        const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                        const afterColon = paragraph.substring(colonIndex + 1);
                        
                        // 冒号前的部分加粗显示
                        ctx.fillStyle = '#333333';
                        ctx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        const beforeWidth = ctx.measureText(beforeColon).width;
                        ctx.fillText(beforeColon, 50, y);
                        
                        // 冒号后的部分使用普通样式
                        ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        
                        // 如果冒号后的内容较长或包含逗号等，另起一行
                        if (afterColon.length > 30 || afterColon.includes('，') || beforeWidth + ctx.measureText(afterColon).width > maxWidth) {
                            y += lineHeight;
                            y = wrapText(ctx, afterColon, 50, y, maxWidth, lineHeight);
                        } else {
                            // 短内容接着冒号后显示
                            ctx.fillText(afterColon, 50 + beforeWidth, y);
                            y += lineHeight;
                        }
                    }
                    // 4. 普通段落
                    else {
                        ctx.fillStyle = '#333333';
                        ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        y = wrapText(ctx, paragraph.trim(), 50, y, maxWidth, lineHeight);
                        y += lineHeight * 0.3;
                    }
                }
                
                // 最终高度（添加底部边距）
                const finalHeight = y + 60;
                
                // 创建新的画布，尺寸刚好容纳内容
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = width;
                finalCanvas.height = finalHeight;
                const finalCtx = finalCanvas.getContext('2d');
                
                // 从临时画布复制内容到最终画布
                finalCtx.drawImage(canvas, 0, 0, width, finalHeight, 0, 0, width, finalHeight);
                
                // 获取最终图像数据
                const imageData = finalCanvas.toDataURL('image/png');
                
                // 显示预览
                const previewArea = document.getElementById(`${tabId}-preview`);
                previewArea.style.display = 'flex';
                const previewImage = document.getElementById(`${tabId}-image`);
                previewImage.src = imageData;
                
                // 显示提示信息
                let pageInfoElem = document.getElementById(`${tabId}-page-info`);
                if (!pageInfoElem) {
                    pageInfoElem = document.createElement('div');
                    pageInfoElem.id = `${tabId}-page-info`;
                    pageInfoElem.className = 'page-info';
                    previewArea.appendChild(pageInfoElem);
                }
                pageInfoElem.textContent = `已生成长图，高度: ${finalHeight}px`;
                
                // 清空多图预览并添加长图
                clearMultiPreview();
                addImageToMultiPreview(imageData, `${getTitle(tabId)}(长图)`, 1, 1);
                
                // 更新右侧预览标题
                const previewHeader = document.getElementById('preview-header');
                previewHeader.textContent = '长图预览';
                
                progressIndicator.style.display = 'none';
            } catch (error) {
                console.error('生成长图处理过程出错:', error);
                progressIndicator.style.display = 'none';
                alert('生成长图时出错: ' + error.message);
            }
        }, 100); // 给浏览器一点时间更新UI
    } catch (error) {
        console.error('生成长图初始化出错:', error);
        document.getElementById('progress-indicator').style.display = 'none';
        alert('生成长图初始化出错: ' + error.message);
    }
}

// 导出所有模块长图
function exportAllLongImages() {
    const progressIndicator = document.getElementById('progress-indicator');
    progressIndicator.style.display = 'block';
    progressIndicator.textContent = '正在准备所有模块长图，请稍候...';
    
    // 获取所有模块ID
    const moduleIds = [
        'user-needs', 
        'high-pay', 
        'search-intent', 
        'pre-needs', 
        'low-competition',
        'selling-points', 
        'diff-service',
        'trust-words',
        'user-thoughts', 
        'content-ideas', 
        'project-analysis'
    ];
    
    // 过滤出有内容的模块
    const modulesWithContent = moduleIds.filter(id => {
        const editor = document.getElementById(`${id}-editor`);
        return editor && editor.value.trim().length > 0;
    });
    
    if (modulesWithContent.length === 0) {
        progressIndicator.style.display = 'none';
        alert('没有找到任何有内容的模块，请先填写内容');
        return;
    }
    
    // 创建ZIP包
    const zip = new JSZip();
    let processedCount = 0;
    
    // 更新进度信息
    progressIndicator.textContent = `正在处理 ${modulesWithContent.length} 个模块，已完成: 0`;
    
    // 处理每个模块
    processNextModule(0);
    
    function processNextModule(index) {
        if (index >= modulesWithContent.length) {
            // 所有模块已处理完毕，生成并下载ZIP
            progressIndicator.textContent = '正在生成ZIP包，请稍候...';
            
            zip.generateAsync({type: 'blob'}).then(function(content) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = '所有模块长图.zip';
                link.click();
                
                progressIndicator.style.display = 'none';
            });
            
            return;
        }
        
        const tabId = modulesWithContent[index];
        progressIndicator.textContent = `正在处理: ${getTitle(tabId)}，进度: ${index + 1}/${modulesWithContent.length}`;
        
        // 获取内容
        const editor = document.getElementById(`${tabId}-editor`);
        const text = editor.value.trim();
        
        // 清理前缀和markdown标记
        let cleanedText = text.replace(/^好的[，,].*?[。\n]/, '');
        cleanedText = cleanedText.replace(/^我来分析.*?[。\n]/, '');
        cleanedText = cleanedText.replace(/##/g, ''); // 去除所有##标记
        cleanedText = cleanedText.replace(/\n#+\s*/g, '\n'); // 去除可能的markdown标题标记
        
        // 创建临时画布
        const canvas = document.createElement('canvas');
        const width = 900;
        canvas.width = width;
        canvas.height = 8000; // 临时大尺寸
        
        const ctx = canvas.getContext('2d');
        
        // 获取用户设置
        const fontSize = getFontSize(tabId);
        const lineHeight = getLineHeight(tabId);
        
        // 获取解释文本和主题色
        const explanation = getExplanation(tabId);
        const themeColor = getColorForTab(tabId);
        const title = getTitle(tabId);
        
        // 准备段落
        const paragraphs = cleanedText.split('\n');
        
        // 填充白色背景
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, width, 8000);
        
        // 计算标题区域高度
        const headerHeight = 240; // 恢复原始标题区域高度
        
        // 绘制标题背景
        if (titleBgStyle === 'gradient') {
            // 渐变背景
            const gradient = ctx.createLinearGradient(0, 0, 0, headerHeight);
            gradient.addColorStop(0, themeColor);  
            gradient.addColorStop(0.5, bgColor);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, headerHeight);
        } else {
            // 纯色标题背景 - 增加高度
            ctx.fillStyle = themeColor;
            ctx.fillRect(0, 0, width, headerHeight * 0.7);
        }
        
        // 绘制标题
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 40px Arial, "Microsoft YaHei", "微软雅黑"';
        ctx.fillText(title, 50, 80);
        
        // 绘制解释文本
        if (explanation) {
            ctx.fillStyle = '#333333'; // 恢复为深色文本
            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
            
            // 使用原始的文本包装函数
            wrapText(ctx, explanation, 50, 120, width - 100, lineHeight);
        }
        
        // 开始绘制内容
        let y = headerHeight;
        const maxWidth = width - 100;
        
        // 绘制所有段落并记录实际高度
        for (const paragraph of paragraphs) {
            if (paragraph.trim() === '') {
                y += lineHeight * 0.5;
                continue;
            }
            
            // 特殊格式处理
            // 1. 数字标题 (如 "1. 标题")
            if (/^\d+[\.\、]/.test(paragraph.trim())) {
                ctx.fillStyle = themeColor;
                ctx.font = `bold ${fontSize+6}px Arial, "Microsoft YaHei", "微软雅黑"`;
                y = wrapText(ctx, paragraph.trim(), 50, y, maxWidth, lineHeight * 1.2);
                y += lineHeight * 0.5;
                
                // 重置样式
                ctx.fillStyle = '#333333';
                ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
            } 
            // 2. 用户角度的心声部分
            else if (paragraph.trim().startsWith('用户角度的心声：')) {
                // 分离冒号前后的部分
                const colonIndex = paragraph.indexOf('：');
                const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                const afterColon = paragraph.substring(colonIndex + 1);
                
                // 冒号前的部分使用普通加粗样式
                ctx.fillStyle = '#333333';
                ctx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                ctx.fillText(beforeColon, 50, y);
                
                const beforeWidth = ctx.measureText(beforeColon).width;
                
                // 冒号后的部分使用普通样式
                ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                
                // 如果冒号后内容较长，另起一行
                if (afterColon.length > 20 || beforeWidth + ctx.measureText(afterColon).width > maxWidth) {
                    y += lineHeight;
                    y = wrapText(ctx, afterColon, 50, y, maxWidth, lineHeight);
                } else {
                    // 短内容接着冒号后显示
                    ctx.fillText(afterColon, 50 + beforeWidth, y);
                    y += lineHeight;
                }
                
                // 重置样式
                ctx.fillStyle = '#333333';
                ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
            }
            // 3. 冒号标题
            else if (paragraph.includes('：') && paragraph.indexOf('：') < 30) {
                // 分离冒号前后的部分
                const colonIndex = paragraph.indexOf('：');
                const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                const afterColon = paragraph.substring(colonIndex + 1);
                
                // 冒号前的部分加粗显示
                ctx.fillStyle = '#333333';
                ctx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                const beforeWidth = ctx.measureText(beforeColon).width;
                ctx.fillText(beforeColon, 50, y);
                
                // 冒号后的部分使用普通样式
                ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                
                // 如果冒号后的内容较长或包含逗号等，另起一行
                if (afterColon.length > 30 || afterColon.includes('，') || beforeWidth + ctx.measureText(afterColon).width > maxWidth) {
                    y += lineHeight;
                    y = wrapText(ctx, afterColon, 50, y, maxWidth, lineHeight);
                } else {
                    // 短内容接着冒号后显示
                    ctx.fillText(afterColon, 50 + beforeWidth, y);
                    y += lineHeight;
                }
            }
            // 4. 普通段落
            else {
                ctx.fillStyle = '#333333';
                ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                y = wrapText(ctx, paragraph.trim(), 50, y, maxWidth, lineHeight);
                y += lineHeight * 0.3;
            }
        }
        
        // 最终高度（添加底部边距）
        const finalHeight = y + 60;
        
        // 创建新的画布，尺寸刚好容纳内容
        const finalCanvas = document.createElement('canvas');
        finalCanvas.width = width;
        finalCanvas.height = finalHeight;
        const finalCtx = finalCanvas.getContext('2d');
        
        // 从临时画布复制内容到最终画布
        finalCtx.drawImage(canvas, 0, 0, width, finalHeight, 0, 0, width, finalHeight);
        
        // 获取最终图像数据并转为Blob
        finalCanvas.toBlob(function(blob) {
            // 将图片添加到ZIP
            zip.file(`${getTitle(tabId)}长图.png`, blob);
            
            // 处理下一个模块
            processedCount++;
            progressIndicator.textContent = `已处理 ${processedCount}/${modulesWithContent.length} 个模块`;
            
            // 延迟处理下一个，给UI留出时间更新
            setTimeout(() => {
                processNextModule(index + 1);
            }, 200);
        }, 'image/png');
    }
}

// 导出所有模块短图
function exportAllShortImages() {
    const progressIndicator = document.getElementById('progress-indicator');
    progressIndicator.style.display = 'block';
    progressIndicator.textContent = '正在准备所有模块短图，请稍候...';
    
    // 获取所有模块ID
    const moduleIds = [
        'user-needs', 
        'high-pay', 
        'search-intent', 
        'pre-needs', 
        'low-competition',
        'selling-points', 
        'user-thoughts', 
        'content-ideas', 
        'project-analysis'
    ];
    
    // 过滤出有内容的模块
    const modulesWithContent = moduleIds.filter(id => {
        const editor = document.getElementById(`${id}-editor`);
        return editor && editor.value.trim().length > 0;
    });
    
    if (modulesWithContent.length === 0) {
        progressIndicator.style.display = 'none';
        alert('没有找到任何有内容的模块，请先填写内容');
        return;
    }
    
    // 创建ZIP包和计数器
    const zip = new JSZip();
    let processedModules = 0;
    let totalImages = 0;
    let processedImages = 0;
    
    // 存储每个模块的图片数据
    const allImageData = {};
    
    // 更新进度信息
    progressIndicator.textContent = `正在处理 ${modulesWithContent.length} 个模块...`;
    
    // 为每个模块创建一个临时监听器来捕获生成的图片
    modulesWithContent.forEach((tabId, index) => {
        // 准备捕获图片的数组
        allImageData[tabId] = [];
        
        // 创建一个临时容器来存储预览图片
        const tempContainer = document.createElement('div');
        tempContainer.style.display = 'none';
        document.body.appendChild(tempContainer);
        
        // 保存原始预览区，稍后恢复
        const originalPreviewArea = document.getElementById(`${tabId}-preview`);
        const originalDisplay = originalPreviewArea.style.display;
        
        // 临时修改预览区域的引用
        const tempPreviewArea = document.createElement('div');
        tempPreviewArea.id = `${tabId}-preview-temp`;
        tempPreviewArea.style.display = 'none';
        const tempPreviewImg = document.createElement('img');
        tempPreviewImg.id = `${tabId}-image-temp`;
        tempPreviewArea.appendChild(tempPreviewImg);
        tempContainer.appendChild(tempPreviewArea);
        
        // 覆盖默认的addImageToMultiPreview函数，捕获生成的图片
        const originalAddImageFunction = window.addImageToMultiPreview;
        window.addImageToMultiPreview = function(imageData, title, page, totalPages) {
            // 保存图片数据
            allImageData[tabId].push({
                url: imageData,
                title: title,
                page: page,
                totalPages: totalPages
            });
            
            // 如果是最后一页，触发下一个模块的处理
            if (page === totalPages) {
                processedModules++;
                totalImages += totalPages;
                
                // 如果所有模块都处理完毕，开始创建ZIP
                if (processedModules === modulesWithContent.length) {
                    // 恢复原始函数
                    window.addImageToMultiPreview = originalAddImageFunction;
                    
                    // 处理所有收集到的图片
                    progressIndicator.textContent = `正在打包 ${totalImages} 张图片...`;
                    processAllCollectedImages();
                }
            }
        };
        
        // 清空多图预览，避免干扰
        clearMultiPreview();
        
        // 调用现有的生成图片函数
        setTimeout(() => {
            progressIndicator.textContent = `正在处理: ${getTitle(tabId)} (${index + 1}/${modulesWithContent.length})`;
            generateImage(tabId);
        }, index * 300); // 分散调用时间，避免浏览器卡顿
    });
    
    // 处理所有收集到的图片并创建ZIP
    function processAllCollectedImages() {
        // 处理每个模块的图片
        let promises = [];
        
        for (const tabId in allImageData) {
            const images = allImageData[tabId];
            
            images.forEach((image, idx) => {
                const promise = fetch(image.url)
                    .then(res => res.blob())
                    .then(blob => {
                        // 添加到ZIP，创建模块文件夹
                        const fileName = `${image.title}/${image.title}_第${image.page}页.png`;
                        zip.file(fileName, blob);
                        
                        // 更新进度
                        processedImages++;
                        progressIndicator.textContent = `正在打包: ${processedImages}/${totalImages} 张图片`;
                    });
                
                promises.push(promise);
            });
        }
        
        // 当所有图片都处理完毕后生成ZIP
        Promise.all(promises).then(() => {
            progressIndicator.textContent = '正在生成ZIP包，请稍候...';
            
            zip.generateAsync({type: 'blob'}).then(function(content) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = '所有模块短图.zip';
                link.click();
                
                progressIndicator.style.display = 'none';
                
                // 恢复原始的多图预览函数和UI
                clearMultiPreview();
            });
        }).catch(error => {
            console.error('打包图片时出错:', error);
            progressIndicator.style.display = 'none';
            alert('生成ZIP包时出错: ' + error.message);
        });
    }
}

        // 初始化本地存储
        function initLocalStorage() {
            const tabs = [
                'user-needs', 
                'high-pay', 
                'search-intent', 
                'pre-needs', 
                'low-competition',
                'selling-points', 
                'diff-service',
                'trust-words',
                'user-thoughts', 
                'content-ideas', 
                'project-analysis'
            ];
            
            tabs.forEach(tab => {
                const editor = document.getElementById(`${tab}-editor`);
                
                // 恢复内容
                const savedContent = localStorage.getItem(`marketingTool-${tab}`);
                if (savedContent) {
                    editor.value = savedContent;
                }
                
                // 保存编辑内容
                editor.addEventListener('input', function() {
                    localStorage.setItem(`marketingTool-${tab}`, this.value);
                });
            });
        }
        
        // 初始化
        window.addEventListener('load', function() {
            try {
                initLocalStorage();
                
                // 键盘快捷键支持
                document.addEventListener('keydown', function(event) {
                    // 如果多图预览打开时
                    if (document.getElementById('multi-preview').style.display === 'flex') {
                        // 左右箭头切换图片
                        if (event.key === 'ArrowLeft') {
                            showPrevImage();
                        } else if (event.key === 'ArrowRight') {
                            showNextImage();
                        } else if (event.key === 'Escape') {
                            closeMultiPreview();
                        }
                    }
                });
                
                console.log('营销分析工具初始化完成');
            } catch (error) {
                console.error('初始化时出错:', error);
            }
        });

        // 初始化页面后为所有模块添加风格选择器
        function initThemeSelectors() {
            // 获取所有模块ID
            const moduleIds = [
                'user-needs', 
                'high-pay', 
                'search-intent', 
                'pre-needs', 
                'low-competition',
                'selling-points', 
                'diff-service',
                'trust-words',
                'user-thoughts', 
                'content-ideas', 
                'project-analysis'
            ];
            
            // 为每个模块添加风格选择器(如果尚未添加)
            moduleIds.forEach(id => {
                const settingsGroup = document.querySelector(`#${id} .settings-group`);
                if (settingsGroup && !document.getElementById(`${id}-theme`)) {
                    // 创建风格选择器容器
                    const settingsItem = document.createElement('div');
                    settingsItem.className = 'settings-item';
                    
                    // 创建标签
                    const label = document.createElement('label');
                    label.setAttribute('for', `${id}-theme`);
                    label.textContent = '风格:';
                    
                    // 创建选择器
                    const select = document.createElement('select');
                    select.id = `${id}-theme`;
                    
                    // 添加选项
                    const options = [
                        { value: 'default', text: '默认风格' },
                        { value: 'vibrant', text: '活力多彩' },
                        { value: 'warm', text: '温暖橙棕' },
                        { value: 'fresh', text: '清新自然' },
                        { value: 'tropical', text: '热带风情' }
                    ];
                    
                    options.forEach(option => {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        select.appendChild(optionElement);
                    });
                    
                    // 组装并添加到页面
                    settingsItem.appendChild(label);
                    settingsItem.appendChild(select);
                    settingsGroup.appendChild(settingsItem);
                }
            });
        }
        
        // 页面加载完成后执行初始化
        document.addEventListener('DOMContentLoaded', initThemeSelectors);

        // 设置全局顶部菜单的导出按钮颜色
        function updateExportButtonColors() {
            // 获取所有可用的主题风格的名称
            const availableThemes = Object.keys(themeStyles);
            
            // 如果没有可用的主题，则返回
            if (availableThemes.length === 0) return;
            
            // 随机选择一个主题风格
            const randomTheme = availableThemes[Math.floor(Math.random() * availableThemes.length)];
            const themeStyle = themeStyles[randomTheme];
            
            // 查找并更新导出按钮的颜色
            const exportButtons = document.querySelectorAll('.export-all-button');
            
            if (exportButtons.length >= 2) {
                // 第一个按钮使用第一个模块的颜色
                if (themeStyle && themeStyle.primary && themeStyle.primary['user-needs']) {
                    exportButtons[0].style.backgroundColor = themeStyle.primary['user-needs'];
                }
                
                // 第二个按钮使用第二个模块的颜色
                if (themeStyle && themeStyle.primary && themeStyle.primary['high-pay']) {
                    exportButtons[1].style.backgroundColor = themeStyle.primary['high-pay'];
                }
            }
        }
        
        // 在页面加载完成后执行初始化主题选择器和按钮颜色
        document.addEventListener('DOMContentLoaded', function() {
            initThemeSelectors();
            setTimeout(updateExportButtonColors, 500); // 稍微延迟，确保DOM已完全加载
        });

        // 应用全局主题
        function applyGlobalTheme() {
            const globalThemeSelect = document.getElementById('global-theme');
            const selectedTheme = globalThemeSelect.value;
            
            if (!selectedTheme) return; // 如果是空值，不执行任何操作
            
            // 获取所有模块ID
            const moduleIds = [
                'user-needs', 
                'high-pay', 
                'search-intent', 
                'pre-needs', 
                'low-competition',
                'selling-points', 
                'diff-service',
                'trust-words',
                'user-thoughts', 
                'content-ideas', 
                'project-analysis'
            ];
            
            // 为每个模块设置相同的主题
            moduleIds.forEach(id => {
                const themeSelect = document.getElementById(`${id}-theme`);
                if (themeSelect) {
                    themeSelect.value = selectedTheme;
                }
            });
            
            // 更新导出按钮颜色
            if (themeStyles[selectedTheme] && themeStyles[selectedTheme].primary) {
                const buttons = document.querySelectorAll('.export-all-button');
                
                if (buttons.length >= 2) {
                    // 设置第一个按钮颜色
                    const color1 = themeStyles[selectedTheme].primary['user-needs'] || '#4a6cf7';
                    buttons[0].style.backgroundColor = color1;
                    
                    // 设置第二个按钮颜色
                    const color2 = themeStyles[selectedTheme].primary['high-pay'] || '#2c3e50';
                    buttons[1].style.backgroundColor = color2;
                }
            }
            
            // 显示应用成功提示
            const progressIndicator = document.getElementById('progress-indicator');
            progressIndicator.style.display = 'block';
            progressIndicator.textContent = `已将全局风格更改为: ${globalThemeSelect.options[globalThemeSelect.selectedIndex].text}`;
            
            // 3秒后隐藏提示
            setTimeout(() => {
                progressIndicator.style.display = 'none';
            }, 3000);
        }
        
        // 显示主题预览面板
        function showThemePreview() {
            const globalThemeSelect = document.getElementById('global-theme');
            const selectedTheme = globalThemeSelect.value || 'default';
            const themeName = globalThemeSelect.options[globalThemeSelect.selectedIndex].text || '默认风格';
            
            // 获取主题样式
            const themeStyle = themeStyles[selectedTheme];
            if (!themeStyle) return;
            
            // 更新预览面板标题
            document.getElementById('preview-theme-name').textContent = `${themeName} 预览`;
            
            // 更新预览面板标题背景色
            const previewHeader = document.querySelector('.theme-preview-header');
            previewHeader.style.background = themeStyle.primary ? (themeStyle.primary['user-needs'] || '#4a6cf7') : '#4a6cf7';
            
            // 更新预览面板示例容器背景色
            const previewContainer = document.getElementById('preview-sample-container');
            previewContainer.style.background = themeStyle.background || '#ffffff';
            
            // 更新示例标题颜色
            const previewSampleHeader = document.getElementById('preview-sample-header');
            previewSampleHeader.style.color = themeStyle.primary ? (themeStyle.primary['user-needs'] || '#4a6cf7') : '#4a6cf7';
            previewSampleHeader.style.borderColor = themeStyle.primary ? (themeStyle.primary['user-needs'] || '#4a6cf7') : '#4a6cf7';
            
            // 更新示例文本颜色
            const previewSampleText = document.getElementById('preview-sample-text');
            previewSampleText.style.color = themeStyle.text || '#333333';
            
            // 显示预览面板
            document.getElementById('theme-preview-panel').style.display = 'block';
        }
        
        // 隐藏主题预览面板
        function hideThemePreview() {
            document.getElementById('theme-preview-panel').style.display = 'none';
        }
        
        // 应用预览中的主题
        function applyPreviewTheme() {
            const globalThemeSelect = document.getElementById('global-theme');
            if (globalThemeSelect.value) {
                applyGlobalTheme();
            }
            hideThemePreview();
        }
        
        // 为主题选择器添加颜色预览
        function enhanceThemeSelectors() {
            // 获取所有主题选择器
            const allThemeSelectors = document.querySelectorAll('select[id$="-theme"]');
            
            allThemeSelectors.forEach(selector => {
                // 获取所有选项
                const options = selector.querySelectorAll('option');
                
                // 为每个选项添加颜色预览
                options.forEach(option => {
                    const themeName = option.value;
                    if (!themeName || !themeStyles[themeName]) return;
                    
                    // 获取该主题的主色
                    let previewColor = '#4a6cf7';
                    if (themeStyles[themeName].primary) {
                        const moduleId = selector.id.replace('-theme', '');
                        previewColor = themeStyles[themeName].primary[moduleId] || Object.values(themeStyles[themeName].primary)[0] || '#4a6cf7';
                    }
                    
                    // 创建颜色预览
                    option.innerHTML = `<div class="theme-option"><span class="theme-preview" style="background-color: ${previewColor}"></span>${option.textContent}</div>`;
                });
            });
        }
        
        // 在页面加载完成后执行初始化
        document.addEventListener('DOMContentLoaded', function() {
            initThemeSelectors();
            setTimeout(() => {
                updateExportButtonColors();
                enhanceThemeSelectors();
            }, 500);
        });

        // 列表符号样式集合
        const bulletStyles = [
            // 几何形状
            { id: 'circle', symbol: '●', colorful: true },
            { id: 'square', symbol: '■', colorful: true },
            { id: 'diamond', symbol: '◆', colorful: true },
            { id: 'triangle', symbol: '▲', colorful: true },
            { id: 'hollow-circle', symbol: '○', colorful: true },
            { id: 'hollow-square', symbol: '□', colorful: true },
            { id: 'hollow-diamond', symbol: '◇', colorful: true },
            // 表情符号
            { id: 'star', symbol: '★', colorful: true },
            { id: 'heart', symbol: '❤', colorful: true },
            { id: 'flower', symbol: '✿', colorful: true },
            { id: 'arrow', symbol: '➤', colorful: true },
            // 表情包
            { id: 'check', symbol: '✓', colorful: true },
            { id: 'smiley', symbol: '😊', colorful: false },
            { id: 'thumbs-up', symbol: '👍', colorful: false },
            { id: 'fire', symbol: '🔥', colorful: false },
            { id: 'bulb', symbol: '💡', colorful: false }
        ];
        
        // 当前选择的列表符号样式
        let currentBulletStyle = bulletStyles[0]; // 默认使用第一个样式

        // 初始化列表符号样式选择器
        function initBulletStyleSelector() {
            const panel = document.getElementById('global-bullet-style-panel');
            if (!panel) return;
            
            panel.innerHTML = ''; // 清空现有内容
            
            bulletStyles.forEach(style => {
                const option = document.createElement('div');
                option.className = 'bullet-style-option';
                option.dataset.bulletId = style.id;
                
                // 选中状态指示
                if (currentBulletStyle.id === style.id) {
                    option.classList.add('active');
                }
                
                // 设置背景色（对于可着色的符号）
                if (style.colorful) {
                    // 为不同的符号设置不同的颜色，使示例更生动
                    const colorMap = {
                        'circle': '#FF5722',
                        'square': '#2196F3',
                        'diamond': '#4CAF50',
                        'triangle': '#9C27B0',
                        'hollow-circle': '#FF9800',
                        'hollow-square': '#3F51B5',
                        'hollow-diamond': '#E91E63',
                        'star': '#FFC107',
                        'heart': '#F44336',
                        'flower': '#8BC34A',
                        'arrow': '#607D8B',
                        'check': '#00BCD4'
                    };
                    
                    option.style.color = colorMap[style.id] || '#333333';
                }
                
                option.textContent = style.symbol;
                
                // 点击事件，选择样式
                option.addEventListener('click', function() {
                    // 移除所有选项的active类
                    document.querySelectorAll('.bullet-style-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    
                    // 添加当前选项的active类
                    this.classList.add('active');
                    
                    // 更新当前选择的样式
                    const selectedId = this.dataset.bulletId;
                    currentBulletStyle = bulletStyles.find(style => style.id === selectedId);
                    
                    // 显示提示信息
                    const progressIndicator = document.getElementById('progress-indicator');
                    progressIndicator.style.display = 'block';
                    progressIndicator.textContent = `已将列表符号样式更改为: ${currentBulletStyle.symbol}`;
                    
                    // 3秒后隐藏提示
                    setTimeout(() => {
                        progressIndicator.style.display = 'none';
                    }, 3000);
                });
                
                panel.appendChild(option);
            });
        }

        // 获取当前的列表符号样式
        function getBulletSymbol() {
            return currentBulletStyle.symbol;
        }
        
        // 获取当前的列表符号是否可着色
        function isBulletColorful() {
            return currentBulletStyle.colorful;
        }

        // 在页面加载完成后执行初始化
        document.addEventListener('DOMContentLoaded', function() {
            initThemeSelectors();
            initBulletStyleSelector(); // 初始化列表符号样式选择器
            setTimeout(() => {
                updateExportButtonColors();
                enhanceThemeSelectors();
            }, 500);
        });

        // 估算段落高度函数
        function estimateParagraphHeight(paragraph, fontSize, lineHeight, maxWidth) {
            // 无序列表项的处理
            if (/^\s*[-•*⦿◉◆◇○●✓☑]/.test(paragraph.trim())) {
                // 无序列表项用稍大的缩进和较大的行高
                const content = paragraph.trim().replace(/^[-•*⦿◉◆◇○●✓☑]\s*/, '');
                const bulletWidth = fontSize; // 估计符号宽度
                
                const lines = Math.ceil(estimateTextWidth(content, fontSize) / (maxWidth - bulletWidth - 50));
                return lines * lineHeight * 1.2; // 给无序列表项一点额外的空间
            }
            // 其他类型段落的处理保持不变
            else if (/^\d+[.、]/.test(paragraph.trim())) {
                // 编号标题用更大的行高
                const lines = Math.ceil(estimateTextWidth(paragraph, fontSize) / maxWidth);
                return lines * lineHeight * 1.5;
            } else {
                // 普通段落
                const lines = Math.ceil(estimateTextWidth(paragraph, fontSize) / maxWidth);
                return lines * lineHeight;
            }
        }
    </script>
</body>
</html>
